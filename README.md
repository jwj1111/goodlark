# GoodLark (é£ä¹¦è¡¨æ ¼ Python åŠ©æ‰‹)

**GoodLark** (`goodlark.py`) æ˜¯ä¸€ä¸ªåŸºäº `lark-oapi` å°è£…çš„ Python ç±»åº“ï¼Œæ—¨åœ¨ç®€åŒ–é£ä¹¦ï¼ˆLarkï¼‰ç”µå­è¡¨æ ¼çš„æœ¬åœ°è°ƒç”¨ä¸æ•°æ®äº¤äº’ã€‚

å®ƒå°è£…äº†ç¹ççš„ API è¯·æ±‚ç»†èŠ‚ï¼Œæä¾›äº†é’ˆå¯¹ Pandas DataFrame çš„ç›´æ¥è¯»å†™æ”¯æŒã€å¤§æ‰¹é‡æ•°æ®çš„è‡ªåŠ¨åˆ†æ‰¹å¤„ç†ã€è¿›åº¦æ¡æ˜¾ç¤ºä»¥åŠè‡ªåŠ¨ Token åˆ·æ–°æœºåˆ¶ã€‚

> **ğŸ˜€ğŸ˜€ğŸ˜€** Wish you GOOD LARK\!

## åŠŸèƒ½ç‰¹æ€§

  * **è‡ªåŠ¨é‰´æƒ**ï¼šè‡ªåŠ¨è·å–å’Œåˆ·æ–° `tenant_access_token`ï¼Œæ— éœ€æ‹…å¿ƒ Token è¿‡æœŸï¼ˆv1.1 æ–°å¢ï¼‰ã€‚
  * **Pandas æ·±åº¦é›†æˆ**ï¼š
      * æ”¯æŒç›´æ¥å°†é£ä¹¦è¡¨æ ¼è¯»å–ä¸º DataFrameã€‚
      * æ”¯æŒå°† DataFrameã€Dict æˆ– List ç›´æ¥å†™å…¥é£ä¹¦è¡¨æ ¼ã€‚
  * **æ‰¹é‡è¯»å†™ä¼˜åŒ–**ï¼š
      * è¯»å–/å†™å…¥å¤§æ•°æ®é‡æ—¶è‡ªåŠ¨åˆ†æ‰¹ï¼ˆBatchï¼‰å¤„ç†ã€‚
      * é›†æˆ `tqdm` è¿›åº¦æ¡ï¼Œå®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦ã€‚
      * å†…ç½®é‡è¯•æœºåˆ¶ï¼Œåº”å¯¹ç½‘ç»œæ³¢åŠ¨ã€‚
  * **æ•°æ®æ¸…æ´—**ï¼š
      * å†™å…¥æ—¶è‡ªåŠ¨å¤„ç† `np.nan`ã€`None` ç­‰ç©ºå€¼ã€‚
      * è¯»å–æ—¶è‡ªåŠ¨å»é™¤å…¨ç©ºè¡Œå’Œæ— æ•ˆåˆ—ã€‚
  * **è¡¨æ ¼ç®¡ç†**ï¼šæ”¯æŒåˆ›å»ºç”µå­è¡¨æ ¼ã€æ–°å¢ Sheetã€è·å– Sheet ID æ˜ å°„ç­‰ã€‚

## ä¾èµ–å®‰è£…

åœ¨ä½¿ç”¨æœ¬åº“ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²å®‰è£…ä»¥ä¸‹ Python ä¾èµ–åº“ï¼š

```bash
pip install lark-oapi pandas requests requests-toolbelt tqdm fastapi
```

## å¿«é€Ÿå¼€å§‹

### 1\. åˆå§‹åŒ–

é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªé£ä¹¦è‡ªå»ºåº”ç”¨ï¼Œå¹¶è·å– `App ID` å’Œ `App Secret`ã€‚

```python
from goodlark import goodlark
# å¡«å…¥ä½ çš„é£ä¹¦åº”ç”¨å‡­è¯
APP_ID = "cli_a1b2c3d4e5"
APP_SECRET = "your_app_secret_here"
# åˆå§‹åŒ–å®ä¾‹
gl = goodlark(APP_ID, APP_SECRET)
```

### 2\. è¯»å–æ•°æ® (Read)

**å°†è¡¨æ ¼æ•°æ®è¯»å–ä¸º DataFrameï¼š**

```python
spreadsheet_token = "shtcn......" # ç”µå­è¡¨æ ¼çš„ Token (URL ä¸­å¯æ‰¾åˆ°)
sheet_name = "Sheet1"
# è¯»å–ä»ç¬¬1è¡Œåˆ°100è¡Œï¼ŒAåˆ—åˆ°Kåˆ—çš„æ•°æ®
df = gl.load_sheet_data_to_df(
    spreadsheet_token = spreadsheet_token,
    sheet_name = sheet_name,
    row_id_start = 1,
    row_id_end = 100,
    col_id_start = "A",
    col_id_end = "K",
    batch_size = 200  # å¯é€‰ï¼šæ¯æ‰¹æ¬¡è¯»å–è¡Œæ•°
)
print(df.head())
```

**äº¤äº’å¼è¯»å–ï¼ˆå‘½ä»¤è¡Œå‘å¯¼ï¼‰ï¼š**

å¦‚æœä½ ä¸æƒ³æ‰‹åŠ¨è¾“å…¥å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨äº¤äº’æ¨¡å¼ï¼š

```python
df = gl.select_from_sheet_to_df()
# è·Ÿéšç»ˆç«¯æç¤ºè¾“å…¥ Tokenã€èŒƒå›´ç­‰ä¿¡æ¯å³å¯
```

### 3\. å†™å…¥æ•°æ® (Write)

**æ‰¹é‡å†™å…¥ DataFrame (æ¨è)ï¼š**

é€‚ç”¨äºå¤§é‡æ•°æ®å†™å…¥ï¼Œä¼šè‡ªåŠ¨å¤„ç†åˆ†æ‰¹å’Œè¿›åº¦æ¡ã€‚

```python
import pandas as pd
import numpy as np
# å‡†å¤‡æ•°æ®
data = {
    'å§“å': ['å¼ ä¸‰', 'æå››', 'ç‹äº”'],
    'å¹´é¾„': [25, np.nan, 30],  # è‡ªåŠ¨å¤„ç† NaN ä¸ºç©ºå•å…ƒæ ¼
    'éƒ¨é—¨': ['æŠ€æœ¯éƒ¨', 'äº§å“éƒ¨', 'è¿è¥éƒ¨']
}
df_to_write = pd.DataFrame(data)
# å†™å…¥æ•°æ®
gl.batch_write_multi_data(
    spreadsheet_token = spreadsheet_token,
    sheet_name = "Sheet1",
    start_loc = "A1",       # ä» A1 å•å…ƒæ ¼å¼€å§‹å†™å…¥
    input_data = df_to_write,
    batch_size = 100        # æ¯æ‰¹æ¬¡å†™å…¥è¡Œæ•°
)
```

**å†™å…¥å•ä¸ªå•å…ƒæ ¼ï¼š**

```python
gl.write_single_data(spreadsheet_token, "Sheet1", "E5", "é€šè¿‡")
```

### 4\. è¡¨æ ¼ç®¡ç† (Manage)

**æ–°å»ºç”µå­è¡¨æ ¼ï¼š**  

**è¯·ç¡®ä¿è‡ªå»ºåº”ç”¨æœ‰æ–‡ä»¶å¤¹æƒé™ï¼Œå¿«æ·æ–¹å¼ï¼šå°†è‡ªå»ºåº”ç”¨æ‹‰å…¥ç¾¤èŠï¼Œå¹¶ä¸ºè¯¥ç¾¤å¼€é€šæ–‡ä»¶å¤¹æƒé™**

```python
# folder_token ä¸ºé£ä¹¦äº‘æ–‡æ¡£æ–‡ä»¶å¤¹çš„ token
res = gl.create_spreadsheet(folder_token = "fld......", spreadsheet_name = "æ ¸å¿ƒæŒ‡æ ‡")
print(res['url'])
```

**æ–°å»º Sheet é¡µï¼š**

```python
gl.create_sheet(spreadsheet_token, "æ–°æ•°æ®")
```

**è·å– Sheet åç§°ä¸ ID çš„æ˜ å°„ï¼š**

```python
mapping = gl.get_name_id_dict(spreadsheet_token)
print(mapping) 
# è¾“å‡ºç¤ºä¾‹: {'Sheet1': 'xxxxxx', '2æœˆæ•°æ®': 'yyyyyy'}
```

## æ³¨æ„äº‹é¡¹

1.  **æƒé™è®¾ç½®**ï¼š
      * **è¯»å†™æƒé™**ï¼šè¯·ç¡®ä¿ä½ çš„é£ä¹¦æœºå™¨äººï¼ˆBotï¼‰å·²è¢«æ·»åŠ ä¸ºè¯¥ç”µå­è¡¨æ ¼çš„åä½œè€…ï¼Œæˆ–è€…è¡¨æ ¼æ‰€åœ¨çš„æ–‡ä»¶å¤¹å·²å¯¹ Bot æˆæƒã€‚
      * **åˆ›å»ºæƒé™**ï¼šä½¿ç”¨ `create_spreadsheet` æ—¶ï¼ŒBot å¿…é¡»æ‹¥æœ‰ç›®æ ‡æ–‡ä»¶å¤¹çš„ç¼–è¾‘æƒé™ã€‚
2.  **API é¢‘ç‡é™åˆ¶**ï¼š
      * ä»£ç å†…éƒ¨å·²é’ˆå¯¹æ‰¹é‡å†™å…¥ï¼ˆ`batch_write_multi_data`ï¼‰å’Œè¯»å–åšäº†ç®€å•çš„é‡è¯•æœºåˆ¶ï¼ˆRetriesï¼‰ï¼Œä½†è‹¥æ•°æ®é‡æå¤§ï¼Œå»ºè®®é€‚å½“è°ƒæ•´ `batch_size`ï¼ˆå»ºè®® 50-200ï¼‰ä»¥é¿å…è§¦å‘é£ä¹¦æœåŠ¡ç«¯çš„é™æµã€‚
3.  **æ•°æ®è¦†ç›–**ï¼š
      * å†™å…¥æ“ä½œä¼šè¦†ç›–ç›®æ ‡èŒƒå›´å†…çš„ç°æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œã€‚


## æ–¹æ³•åˆ—è¡¨
### 1\. åŠŸèƒ½æ€§æ–¹æ³•
è¿™äº›æ˜¯åº•å±‚çš„è¾…åŠ©æ–¹æ³•ï¼Œé€šå¸¸ç”¨äºæ•°æ®è½¬æ¢æˆ–è·å–å¿…è¦çš„ ID ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹è°ƒç”¨ã€‚
| æ–¹æ³•å | å‚æ•° | æè¿° |
| :--- | :--- | :--- |
| **`get_tenant_access_token`** | æ—  | **æ ¸å¿ƒé‰´æƒ**ã€‚å‘é£ä¹¦æœåŠ¡å™¨è¯·æ±‚å¹¶è¿”å›æœ‰æ•ˆçš„ `tenant_access_token`ã€‚ç±»å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•ï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨ä½¿ç”¨ã€‚ |
| **`get_name_id_dict`** | `spreadsheet_token` | **ID æ˜ å°„**ã€‚ä¼ å…¥ç”µå­è¡¨æ ¼ Tokenï¼Œè¿”å›è¯¥è¡¨æ ¼ä¸‹æ‰€æœ‰ Sheet çš„ `{åç§°: ID}` å­—å…¸ã€‚ç”¨äºéœ€è¦ `sheet_id` çš„åœºæ™¯ã€‚ |
| **`to_2d_list`** | `input_data` | **æ ¼å¼è½¬æ¢**ã€‚å°† `pandas.DataFrame` æˆ– `dict` è½¬æ¢ä¸ºç¬¦åˆé£ä¹¦ API æ ‡å‡†çš„äºŒç»´åˆ—è¡¨ï¼ˆList of Listsï¼‰ã€‚ |
| **`complete_data_range`** | `start_loc`, `input_data` | **èŒƒå›´è®¡ç®—**ã€‚åŸºäºèµ·å§‹å•å…ƒæ ¼ï¼ˆå¦‚ "A1"ï¼‰å’Œæ•°æ®å½¢çŠ¶ï¼Œè‡ªåŠ¨è®¡ç®—å®Œæ•´çš„å†™å…¥èŒƒå›´ï¼ˆå¦‚ "A1:C10"ï¼‰ã€‚ |
| **`generate_col_order_info`** | æ—  | **åˆ—æ ‡ç”Ÿæˆ**ã€‚ç”Ÿæˆ Excel é£æ ¼çš„åˆ—æ ‡æ˜ å°„å­—å…¸ï¼ˆA-ZZï¼‰ï¼Œç”¨äºå†…éƒ¨åæ ‡è®¡ç®—ã€‚åŒ…å« `åˆ—åâ†’æ•°å­—` å’Œ `æ•°å­—â†’åˆ—å` çš„åŒå‘æ˜ å°„ã€‚ |

### 2\. åˆ›å»ºç”µå­è¡¨æ ¼ä¸Sheet
ç”¨äºåœ¨é£ä¹¦äº‘æ–‡æ¡£ä¸­æ–°å»ºæ–‡ä»¶æˆ–åœ¨è¡¨ä¸­åˆ›å»ºå­è¡¨ã€‚
| æ–¹æ³•å | å‚æ•° | æè¿° |
| :--- | :--- | :--- |
| **`create_spreadsheet`** | `folder_token`, `spreadsheet_name` | **æ–°å»ºè¡¨æ ¼**ã€‚åœ¨æŒ‡å®šçš„é£ä¹¦æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„ç”µå­è¡¨æ ¼ã€‚<br>**æ³¨æ„**ï¼šBot éœ€è¦å¯¹è¯¥æ–‡ä»¶å¤¹æ‹¥æœ‰ç¼–è¾‘æƒé™ã€‚ |
| **`create_sheet`** | `spreadsheet_token`, `sheet_name` | **æ–°å»º Sheet**ã€‚åœ¨æŒ‡å®šçš„ç”µå­è¡¨æ ¼ä¸­æ–°å¢ä¸€ä¸ªå·¥ä½œè¡¨ã€‚ |

### 3\. è¯»å–é£ä¹¦è¡¨æ ¼
æ”¯æŒåŸå§‹æ•°æ®è¯»å–å’Œ Pandas DataFrame å°è£…è¯»å–ã€‚
| æ–¹æ³•å | å‚æ•° | æè¿° |
| :--- | :--- | :--- |
| **`load_sheet_data_to_df`** | `spreadsheet_token`, `sheet_name`, `row_id_start`, `row_id_end`, `col_id_start`, `col_id_end`, `batch_size`, `target_column_names` | **è¯»å–ä¸º DataFrame**ã€‚æŒ‡å®šè¡Œåˆ—èŒƒå›´ï¼Œå°†æ•°æ®è¯»å–å¹¶æ¸…æ´—ä¸º Pandas DataFrameã€‚<br>æ”¯æŒåˆ†æ‰¹è¯»å–ï¼ˆå¸¦æœ‰è¿›åº¦æ¡ï¼‰ä»¥åº”å¯¹å¤§é‡æ•°æ®ã€‚ |
| **`load_data_from_sheet`** | `spreadsheet_token`, `sheet_name`, `data_range` | **åŸå§‹è¯»å–**ã€‚æŒ‡å®šèŒƒå›´ï¼ˆå¦‚ "A1:E10"ï¼‰ï¼Œè¿”å›åŸå§‹çš„äºŒç»´åˆ—è¡¨æ•°æ®ã€‚ |
| **`select_from_sheet_to_df`** | *å¯é€‰å‚æ•°* | **äº¤äº’å¼è¯»å–**ã€‚`load_sheet_data_to_df` çš„äº¤äº’å¼åŒ…è£…å™¨ã€‚æœªä¼ å…¥çš„å‚æ•°ä¼šé€šè¿‡ç»ˆç«¯è¯¢é—®ç”¨æˆ·ï¼ˆå¦‚è¾“å…¥Tokenã€èŒƒå›´ç­‰ï¼‰ï¼Œé€‚åˆè„šæœ¬è°ƒè¯•ä½¿ç”¨ã€‚ |

### 4\. å†™å…¥é£ä¹¦è¡¨æ ¼
æ”¯æŒå•å•å…ƒæ ¼ã€å¤šè¡Œä»¥åŠæ‰¹é‡å¤šè¡Œå†™å…¥ï¼Œå†…ç½®äº†ç©ºå€¼å¤„ç†ã€‚
| æ–¹æ³•å | å‚æ•° | æè¿° |
| :--- | :--- | :--- |
| **`batch_write_multi_data`** | `spreadsheet_token`, `sheet_name`, `start_loc`, `input_data`, `batch_size` | **æ‰¹é‡å†™å…¥ (æ¨è)**ã€‚æ”¯æŒ DataFrame/List/Dictã€‚å°†å¤§æ•°æ®è‡ªåŠ¨åˆ‡åˆ†ä¸ºå°æ‰¹æ¬¡å†™å…¥ï¼ˆé¿å…æŠ¥é”™ 90227ï¼‰ï¼Œå¹¶æ˜¾ç¤ºè¿›åº¦æ¡ã€‚è‡ªåŠ¨å¤„ç† `NaN/None` ä¸ºç©ºå€¼ã€‚ |
| **`write_multi_data`** | `spreadsheet_token`, `sheet_name`, `start_loc`, `input_data` | **å•æ¬¡å†™å…¥**ã€‚ä¸€æ¬¡æ€§å†™å…¥å¤šè¡Œæ•°æ®ã€‚é€‚ç”¨äºå°‘é‡æ•°æ®ï¼Œè‹¥æ•°æ®é‡è¿‡å¤§ä¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸å¹¶å»ºè®®æ”¹ç”¨ `batch` æ–¹æ³•ã€‚ |
| **`write_single_data`** | `spreadsheet_token`, `sheet_name`, `start_loc`, `input_data` | **å•ç‚¹å†™å…¥**ã€‚åœ¨æŒ‡å®šå•å…ƒæ ¼ï¼ˆå¦‚ "A1"ï¼‰å†™å…¥å•ä¸ªå€¼ã€‚ |
| **`select_batch_write_multi_data`** | `input_data`, *å¯é€‰å‚æ•°* | **äº¤äº’å¼å†™å…¥**ã€‚`batch_write_multi_data` çš„äº¤äº’å¼åŒ…è£…å™¨ã€‚æœªä¼ å…¥çš„è¡¨æ ¼ä¿¡æ¯ä¼šé€šè¿‡ç»ˆç«¯è¯¢é—®ç”¨æˆ·ï¼Œåªéœ€æå‰å‡†å¤‡å¥½æ•°æ®å¯¹è±¡å³å¯ã€‚ |

### ğŸ’¡ ä½¿ç”¨å»ºè®®

1.  **æ—¥å¸¸æ•°æ®åˆ†æ**ï¼šä¸»è¦ä½¿ç”¨ `load_sheet_data_to_df` (è¯») å’Œ `batch_write_multi_data` (å†™)ã€‚
2.  **è„šæœ¬è°ƒè¯•**ï¼šå¯ä»¥ä½¿ç”¨ `select_...` å¼€å¤´çš„æ–¹æ³•ï¼Œçœå»æŸ¥é˜…å’Œå¤åˆ¶ç²˜è´´ Token çš„éº»çƒ¦ã€‚
3.  **å·¥å…·å¼€å‘**ï¼šå¦‚æœéœ€è¦å¼€å‘æ›´å¤æ‚çš„é€»è¾‘ï¼Œå¯ä»¥åˆ©ç”¨ `to_2d_list` å’Œ `get_name_id_dict` ç­‰åº•å±‚å·¥å…·æ„å»ºè‡ªå·±çš„æµç¨‹ã€‚

## ç‰ˆæœ¬è®°å½•

  * **v 1.1**
      * [ä¼˜åŒ–] ç§»é™¤ `self.bearer_token` å±æ€§ï¼Œæ”¹ä¸ºæŒ‰éœ€åŠ¨æ€è·å–ï¼Œè§£å†³ Token ä¸¤å°æ—¶è¿‡æœŸé—®é¢˜ã€‚
      * [ä¼˜åŒ–] æ ¸å¿ƒè¯»å†™æ–¹æ³•å¢åŠ  Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ã€‚
  * **v 1.0**
      * è§£å†³ `np.nan`ã€`None` æ— æ³•å†™å…¥é£ä¹¦è¡¨æ ¼çš„é—®é¢˜ã€‚

## ä½œè€…
**@ Wu, J. J.**
*Based on Lark Open API*  

<https://github.com/jwj1111/goodlark>
